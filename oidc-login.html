<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="./oidc-login-provider.html">

<dom-module id="oidc-login">
<template strip-whitespace>

<style>
:host {
	display: block;
}
</style>

<iron-localstorage name="oidc-login-access-token" value="{{accessToken}}" use-raw></iron-localstorage>
<iron-localstorage name="oidc-login-id-token" value="{{idToken}}" use-raw></iron-localstorage>

<div hidden$="[[accessToken]]">
	<slot name="login">
		<template is="dom-repeat" items="[[providerList]]">
			<paper-button on-click="_internalLogin">
				Login<template is="dom-if" if="{{item.name}}"> with [[item.name]]</template>
			</paper-button>
		</template>
	</slot>
</div>

<div hidden$="[[!accessToken]]">
<slot id="mainContent"></slot>
</div>

</template>

<script src="https://cdn.rawgit.com/GluuFederation/openid-implicit-client/master/openidconnect.js"></script>
<script>

class OIDCLogin extends Polymer.Element {

	static get is() { return "oidc-login"; }

	static get properties() {
		return {
			accessToken: { 
				type: Object, 
				notify: true, 
				reflectToAttribute: true,
				observer: '_accessTokenReceived',
				value: false,
			},
			idToken: { 
				type: Object, 
				notify: true, 
				reflectToAttribute: true,
				observer: '_accessTokenReceived',
				value: false,
			},
			provider: { 
				type: String,
				readOnly: true,
				notify: true,
				reflectToAttribute: true
			},
			redirectUri: { 
				type: String, 
				value: '/login-callback.html'
			},
			scope: { 
				type: String,
				value: 'openid profile email' 
			},
			providerList: { 
				type: Array, 
				value: [] 
			},
		};
	}
	
	constructor() {
		super();
	}
	
	logout() {
		this.set('accessToken', null);
	}
	
	login(provider) {
		// choose provider from the list
		if (provider) {
			provider = this.providerList.find(function(p) { return p.getAttribute('name') == provider; });
		} else {
			// or default (first) provider if none specified
			provider = this.providerList[0];
		}
		if (!provider)
			return;
		// init the found provider and start a login session
		provider.init(this.redirectUri);
		this.set('provider', provider.name);
		OIDC.login({scope: this.scope, response_type: 'token id_token'});
	}
	
	connectedCallback() {
		super.connectedCallback();
		// collect provider nodes
		this._observer = new Polymer.FlattenedNodesObserver(this, function(info) {
			(info.addedNodes || []).forEach(function (n){
				if (n.localName != 'oidc-login-provider') return;
				this.push('providerList', n);
			}.bind(this));
		});
	}
	
	disconnectedCallback() {
		super.disconnectedCallback();
		this._observer.disconnect();
		this._provders = [];
	}
	
	_internalLogin(e) {
		this.login(e.model.item.name);
	}
	
	_accessTokenReceived() {
		if (!this.accessToken || !this.idToken)
			return;
		window.requestAnimationFrame(function(elm) {
			this.dispatchEvent(new CustomEvent('oidc-login-success',{ 
				detail: { accessToken: this.accessToken, idToken: this.idToken } 
				}));
		}.bind(this));
	}
}

customElements.define(OIDCLogin.is, OIDCLogin);
</script>

</dom-module>
